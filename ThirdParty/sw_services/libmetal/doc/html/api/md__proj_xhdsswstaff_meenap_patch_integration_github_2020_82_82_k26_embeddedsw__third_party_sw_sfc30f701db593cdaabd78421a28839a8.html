<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.5"/>
<title>libmetal: libmetal</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="HTML_custom.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="xlogo_bg.gif"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">libmetal
   </div>
   <div id="projectbrief">Xilinx Vitis Drivers API Documentation</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.5 -->
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Overview</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li class="current"><a href="pages.html"><span>Examples</span></a></li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('md__proj_xhdsswstaff_meenap_patch_integration_github_2020_82_82_k26_embeddedsw__third_party_sw_sfc30f701db593cdaabd78421a28839a8.html','');});
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">libmetal </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h2>Overview</h2>
<p>Libmetal provides common user APIs to access devices, handle device interrupts and request memory across the following operating environments:</p>
<ul>
<li>Linux user space (based on UIO and VFIO support in the kernel)</li>
<li>RTOS (with and without virtual memory)</li>
<li>Bare-metal environments</li>
</ul>
<h2>Build Steps</h2>
<h3>Building for Linux Host</h3>
<p>``` $ git clone <a href="https://github.com/OpenAMP/libmetal.git">https://github.com/OpenAMP/libmetal.git</a> $ mkdir -p libmetal/&lt;build directory&gt;=""&gt; $ cd libmetal/&lt;build directory&gt;=""&gt; $ cmake .. $ make VERBOSE=1 DESTDIR=&lt;libmetal install="" location&gt;=""&gt; install ```</p>
<h3>Cross Compiling for Linux Target</h3>
<p>Use <a href="https://github.com/openamp/meta-openamp">meta-openamp</a> to build libmetal library. Use package <code>libmetal</code> in your yocto config file.</p>
<h3>Building for Baremetal</h3>
<p>To build on baremetal, you will need to provide a toolchain file. Here is an example toolchain file: ``` set (CMAKE_SYSTEM_PROCESSOR "arm" CACHE STRING "") set (MACHINE "zynqmp_r5" CACHE STRING "")</p>
<p>set (CROSS_PREFIX "armr5-none-eabi-" CACHE STRING "") set (CMAKE_C_FLAGS "-mfloat-abi=soft -mcpu=cortex-r5 -Wall -Werror -Wextra \
       -flto -Os -I/ws/xsdk/r5_0_bsp/psu_cortexr5_0/include" CACHE STRING "")</p>
<p>SET(CMAKE_EXE_LINKER_FLAGS "${CMAKE_EXE_LINKER_FLAGS} -flto") SET(CMAKE_AR "gcc-ar" CACHE STRING "") SET(CMAKE_C_ARCHIVE_CREATE "&lt;CMAKE_AR&gt; qcs &lt;TARGET&gt; &lt;LINK_FLAGS&gt; &lt;OBJECTS&gt;") SET(CMAKE_C_ARCHIVE_FINISH   true)</p>
<p>include (cross-generic-gcc) ``<code></p>
<ul>
<li>Note: other toolchain files can be found in thecmake/platforms/` directory.</li>
<li>Compile with your toolchain file. ``` $ mkdir -p build-libmetal $ cd build-libmetal $ cmake &lt;libmetal_source&gt; -DCMAKE_TOOLCHAIN_FILE=&lt;toolchain_file&gt; $ make VERBOSE=1 DESTDIR=&lt;libmetal_install&gt; install ```</li>
</ul>
<p></code></p>
<p><code></p>
<h3>Building for Zephyr</h3>
<p></code></p>
<p><code> As Zephyr uses CMake, we build libmetal library and test application as targets of Zephyr CMake project. Here is how to build libmetal for Zephyr: ``` $ export ZEPHRY_GCC_VARIANT=zephyr $ export ZEPHRY_SDK_INSTALL_DIR=&lt;where zephyr="" sdk="" is="" installed&gt;=""&gt; $ source &lt;git_clone_zephyr_project_source_root&gt;/zephyr-env.sh</code></p>
<p><code> $ cmake &lt;libmetal_source_root&gt; -DWITH_ZEPHYR=on -DBOARD=qemu_cortex_m3 \ [-DWITH_TESTS=on] $ make VERBOSE=1 all </p>
<h1>If we have turned on tests with "-DWITH_TESTS=on" when we run cmake,</h1>
<p></code></p>
<p><code> </p>
<h1>we launch libmetal test on Zephyr QEMU platform as follows:</h1>
<p></code></p>
<p><code> $ make VERBOSE=1 run ```</code></p>
<p><code></p>
<h2>Interfaces</h2>
<p></code></p>
<p><code></code></p>
<p><code>The following subsections give an overview of interfaces provided by libmetal.</code></p>
<p><code></p>
<h3>Platform and OS Independent Utilities</h3>
<p></code></p>
<p><code></code></p>
<p><code>These interfaces do not need to be ported across to new operating systems.</code></p>
<p><code></p>
<h4>I/O</h4>
<p></code></p>
<p><code></code></p>
<p><code>The libmetal I/O region abstraction provides access to memory mapped I/O and shared memory regions. This includes:</p>
<ul>
<li>primitives to read and write memory with ordering constraints, and</li>
<li>ability to translate between physical and virtual addressing on systems that support virtual memory.</li>
</ul>
<p></code></p>
<p><code></p>
<h4>Log</h4>
<p></code></p>
<p><code></code></p>
<p><code>The libmetal logging interface is used to plug log messages generated by libmetal into application specific logging mechanisms (e.g. syslog). This also provides basic message prioritization and filtering mechanisms.</code></p>
<p><code></p>
<h4>List</h4>
<p></code></p>
<p><code></code></p>
<p><code>This is a simple doubly linked list implementation used internally within libmetal, and also available for application use.</code></p>
<p><code></p>
<h4>Other Utilities</h4>
<p></code></p>
<p><code></code></p>
<p><code>The following utilities are provided in lib/utilities.h:</p>
<ul>
<li>Min/max, round up/down, etc.</li>
<li>Bitmap operations</li>
<li>Helper to compute container structure pointers</li>
<li>... and more ...</li>
</ul>
<p></code></p>
<p><code></p>
<h4>Version</h4>
<p></code></p>
<p><code></code></p>
<p><code>The libmetal version interface allows user to get the version of the library.</code></p>
<p><code></p>
<h3>Top Level Interfaces</h3>
<p></code></p>
<p><code></code></p>
<p><code>The users will need to call two top level interfaces to use libmetal APIs:</p>
<ul>
<li>metal_init - initialize the libmetal resource</li>
<li>metal_finish - release libmetal resource</li>
</ul>
<p></code></p>
<p><code>Each system needs to have their own implementation inside libmetal for these two APIs to call:</p>
<ul>
<li>metal_sys_init</li>
<li>metal_sys_finish</li>
</ul>
<p></code></p>
<p><code>For the current release, libmetal provides Linux userspace and bare-metal implementation for metal_sys_init and metal_sys_finish.</code></p>
<p><code>For Linux userspace, metal_sys_init sets up a table for available shared pages, checks whether UIO/VFIO drivers are avail, and starts interrupt handling thread.</code></p>
<p><code>For bare-metal, metal_sys_init and metal_sys_finish just returns.</code></p>
<p><code></p>
<h3>Atomics</h3>
<p></code></p>
<p><code></code></p>
<p><code>The libmetal atomic operations API is consistent with the C11/C++11 stdatomics interface. The stdatomics interface is commonly provided by recent toolchains including GCC and LLVM/Clang. When porting to a different toolchain, it may be necessary to provide an stdatomic compatible implementation if the toolchain does not already provide one.</code></p>
<p><code></p>
<h3>Alloc</h3>
<p></code></p>
<p><code></code></p>
<p><code>libmetal provides memory allocation and release APIs.</code></p>
<p><code></p>
<h3>Locking</h3>
<p></code></p>
<p><code></code></p>
<p><code>libmetal provides the following locking APIs.</code></p>
<p><code></p>
<h4>Mutex</h4>
<p></code></p>
<p><code></code></p>
<p><code>libmetal has a generic mutex implementation which is a busy wait. It is recommended to have OS specific implementation for mutex.</code></p>
<p><code>The Linux userspace mutex implementation uses futex to wait for the lock and wakeup a waiter.</code></p>
<p><code></p>
<h4>Condition Variable</h4>
<p></code></p>
<p><code> libmetal condition variable APIs provide "wait" for user applications to wait on some condition to be met, and "signal" to indicate a particular even occurs.</code></p>
<p><code></p>
<h4>Spinlock</h4>
<p></code></p>
<p><code> libmetal spinlock APIs provides busy waiting mechanism to acquire a lock.</code></p>
<p><code></p>
<h3>Shmem</h3>
<p></code></p>
<p><code></code></p>
<p><code>libmetal has a generic static shared memory implementation. If your OS has a global shared memory allocation, you will need to port it for the OS.</code></p>
<p><code>The Linux userspace shmem implementation uses libhugetlbfs to support huge page sizes.</code></p>
<p><code></p>
<h3>Bus and Device Abstraction</h3>
<p></code></p>
<p><code></code></p>
<p><code>libmetal has a static generic implementation. If your OS has a driver model implementation, you will need to port it for the OS.</code></p>
<p><code>The Linux userspace abstraction binds the devices to UIO or VFIO driver. The user applications specify which device to use, e.g. bus "platform" bus, device "f8000000.slcr", and then the abstraction will check if platform UIO driver or platform VFIO driver is there. If platform VFIO driver exists, it will bind the device to the platform VFIO driver, otherwise, if UIO driver exists, it will bind the device to the platform UIO driver.</code></p>
<p><code>The VFIO support is not yet implemented.</code></p>
<p><code></p>
<h3>Interrupt</h3>
<p></code></p>
<p><code></code></p>
<p><code>libmetal provides APIs to register an interrupt, disable interrupts and restore interrupts.</code></p>
<p><code>The Linux userspace implementation will use a thread to call select() function to listen to the file descriptors of the devices to see if there is an interrupt triggered. If there is an interrupt triggered, it will call the interrupt handler registered by the user application.</code></p>
<p><code></p>
<h3>Cache</h3>
<p></code></p>
<p><code></code></p>
<p><code>libmetal provides APIs to flush and invalidate caches.</code></p>
<p><code>The cache APIs for Linux userspace are empty functions for now as cache operations system calls are not avaiable for all architectures.</code></p>
<p><code></p>
<h3>DMA</h3>
<p></code></p>
<p><code></code></p>
<p><code>libmetal DMA APIs provide DMA map and unmap implementation.</code></p>
<p><code>After calling DMA map, the DMA device will own the memory. After calling DMA unmap, the cpu will own the memory.</code></p>
<p><code>For Linux userspace, it only supports to use UIO device memory as DMA memory for this release.</code></p>
<p><code></p>
<h3>Time</h3>
<p></code></p>
<p><code> libmetal time APIs provide getting timestamp implementation.</code></p>
<p><code></p>
<h3>Sleep</h3>
<p></code></p>
<p><code> libmetal sleep APIs provide getting delay execution implementation.</code></p>
<p><code></p>
<h3>Compiler</h3>
<p></code></p>
<p><code></code></p>
<p><code>This API is for compiler dependent functions. For this release, there is only a GCC implementation, and compiler specific code is limited to atomic operations. </code></p>
</div></div><!-- contents -->
</div><!-- doc-content -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Copyright &copy; 2015 Xilinx Inc. All rights reserved.</li>
  </ul>
</div>
</body>
</html>
